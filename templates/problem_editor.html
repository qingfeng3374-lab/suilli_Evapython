<!-- problem_editor.html -->
{% extends "base.html" %}

{% block title %}Suilli - 代码编辑器 - {{ problem.title }}{% endblock %}

{% block content %}
<!-- 主内容区 -->
<main class="container mx-auto px-4 pt-24 pb-12">
    <!-- 题目信息 -->
    <section class="mb-12">
        <h1 class="text-[clamp(1.5rem,3vw,2.5rem)] font-bold mb-4">{{ problem.title }}</h1>
        <p class="text-dark-300 dark:text-light-200 max-w-2xl">{{ problem.description }}</p>
    </section>

    <!-- 代码编辑器 -->
    <section class="mb-16">
        <div class="bg-white dark:bg-dark-300 rounded-xl shadow-elevation-1 p-6">
            <h2 class="text-xl font-semibold mb-4">代码编辑器</h2>
            <div id="code-editor" class="w-full h-64 bg-light-200 dark:bg-dark-100 rounded-lg p-4"></div>
            <button id="clear-code" class="mt-4 bg-gray-300 hover:bg-gray-400 text-gray-800 font-medium px-6 py-3 rounded-lg transition-colors btn-effect mr-2">
                清除代码
            </button>
            <button id="submit-code" class="mt-4 bg-primary hover:bg-primary/90 text-white font-medium px-6 py-3 rounded-lg transition-colors btn-effect">
                提交代码 <i class="fa-solid fa-arrow-right ml-1"></i>
            </button>
        </div>
    </section>

    <!-- 评测结果 -->
    <section id="evaluation-result" class="hidden mb-16">
        <div class="bg-white dark:bg-dark-300 rounded-xl shadow-elevation-1 p-6">
            <h2 class="text-xl font-semibold mb-4">评测结果</h2>
            <p id="result-message" class="text-dark-300 dark:text-light-200 mb-4"></p>
            <pre id="output" class="font-code text-sm bg-gray-50 dark:bg-dark-100 rounded-lg p-3 overflow-x-auto theme-transition"></pre>
            <pre id="error" class="font-code text-sm bg-gray-50 dark:bg-dark-100 rounded-lg p-3 overflow-x-auto theme-transition"></pre>
        </div>
    </section>
</main>

{% endblock %}

{% block scripts %}
<script>
    require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs' }});
    require(['vs/editor/editor.main'], function() {
        const editor = monaco.editor.create(document.getElementById('code-editor'), {
            value: `{{ problem.template|safe }}`,
            language: 'python',
            theme: document.documentElement.classList.contains('dark') ? 'vs-dark' : 'vs',
            automaticLayout: true
        });

        const clearCodeBtn = document.getElementById('clear-code');
        const submitCodeBtn = document.getElementById('submit-code');
        const evaluationResult = document.getElementById('evaluation-result');
        const resultMessage = document.getElementById('result-message');
        const output = document.getElementById('output');
        const error = document.getElementById('error');

        clearCodeBtn.addEventListener('click', () => {
            editor.setValue('');
        });

        submitCodeBtn.addEventListener('click', async () => {
            const code = editor.getValue();
            const problemId = "{{ request.view_args.problem_id|safe }}";

            try {
                const response = await fetch('/evaluate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        code: code,
                        problem: problemId
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                evaluationResult.classList.remove('hidden');
                resultMessage.textContent = data.passed ? '通过评测！' : '未通过评测。';
                output.textContent = data.output;
                error.textContent = data.error;
            } catch (error) {
                evaluationResult.classList.remove('hidden');
                resultMessage.textContent = '请求出错。';
                output.textContent = '';
                error.textContent = error.message;
            }
        });

        // 监听主题切换事件，更新编辑器主题
        const themeToggle = document.getElementById('theme-toggle');
        themeToggle.addEventListener('click', function() {
            const isDark = document.documentElement.classList.contains('dark');
            editor.updateOptions({
                theme: isDark ? 'vs-dark' : 'vs'
            });
        });
    });
</script>
{% endblock %}